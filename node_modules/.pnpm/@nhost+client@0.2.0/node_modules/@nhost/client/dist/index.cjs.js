var oe=Object.create;var T=Object.defineProperty,ae=Object.defineProperties,ie=Object.getOwnPropertyDescriptor,le=Object.getOwnPropertyDescriptors,de=Object.getOwnPropertyNames,N=Object.getOwnPropertySymbols,ce=Object.getPrototypeOf,P=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var W=(e,t,r)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,p=(e,t)=>{for(var r in t||(t={}))P.call(t,r)&&W(e,r,t[r]);if(N)for(var r of N(t))K.call(t,r)&&W(e,r,t[r]);return e},E=(e,t)=>ae(e,le(t)),b=e=>T(e,"__esModule",{value:!0});var F=(e,t)=>{var r={};for(var a in e)P.call(e,a)&&t.indexOf(a)<0&&(r[a]=e[a]);if(e!=null&&N)for(var a of N(e))t.indexOf(a)<0&&K.call(e,a)&&(r[a]=e[a]);return r};var he=(e,t)=>{for(var r in t)T(e,r,{get:t[r],enumerable:!0})},Y=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of de(t))!P.call(e,i)&&(r||i!=="default")&&T(e,i,{get:()=>t[i],enumerable:!(a=ie(t,i))||a.enumerable});return e},D=(e,t)=>Y(b(T(e!=null?oe(ce(e)):{},"default",!t&&e&&e.__esModule?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e),ue=(e=>(t,r)=>e&&e.get(t)||(r=Y(b({}),t,1),e&&e.set(t,r),r))(typeof WeakMap!="undefined"?new WeakMap:0);var B=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var Q=(e,t,r)=>(B(e,t,"read from private field"),r?r.call(e):t.get(e)),X=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},z=(e,t,r,a)=>(B(e,t,"write to private field"),a?a.call(e,r):t.set(e,r),r);var fe={};he(fe,{MIN_PASSWORD_LENGTH:()=>J,MIN_TOKEN_REFRESH_INTERVAL:()=>Z,NHOST_JWT_EXPIRES_AT_KEY:()=>f,NHOST_REFRESH_TOKEN_KEY:()=>R,Nhost:()=>_,NhostSSR:()=>H,REFRESH_TOKEN_RETRY_INTERVAL:()=>Re,REFRESH_TOKEN_RETRY_MAX_ATTEMPTS:()=>ve,TOKEN_REFRESH_MARGIN:()=>$,cookieStorageGetter:()=>V,cookieStorageSetter:()=>G,createChangeEmailMachine:()=>me,createChangePasswordMachine:()=>pe,createNhostMachine:()=>M,createResetPasswordMachine:()=>Ee,defaultStorageGetter:()=>q,defaultStorageSetter:()=>L});var se=require("broadcast-channel");var te=require("broadcast-channel"),re=D(require("immer")),u=require("xstate");var R="nhostRefreshToken",f="nhostRefreshTokenExpiresAt",J=3,$=900,Z=60,Re=10,ve=30;var x={status:10,error:"invalid-email",message:"Email is incorrectly formatted"},I={status:10,error:"invalid-password",message:"Password is incorrectly formatted"};var j=D(require("axios"));var m=e=>{let t=j.default.create({baseURL:e});return t.interceptors.response.use(r=>r,r=>{var a,i,d,c,h;return Promise.reject({error:{message:((i=(a=r.response)==null?void 0:a.data)==null?void 0:i.message)??r.message??r.request.responseText??JSON.stringify(r),status:((d=r.response)==null?void 0:d.status)??((c=r.response)==null?void 0:c.data.statusCode)??0,error:((h=r.response)==null?void 0:h.data.error)||r.request.statusText||"network"}})}),t};var w=e=>!!e&&typeof e=="string"&&String(e).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/),O=e=>!!e&&typeof e=="string"&&e.length>=3;var ee={user:null,mfa:!1,accessToken:{value:null,expiresAt:new Date},refreshTimer:{elapsed:0,attempts:0},refreshToken:{value:null},errors:{}};var v=require("xstate");var me=({backendUrl:e,clientUrl:t,interpreter:r})=>{let a=m(e);return(0,v.createMachine)({schema:{context:{},events:{}},tsTypes:{},id:"changeEmail",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST_CHANGE:[{cond:"invalidEmail",actions:"saveInvalidEmailError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:"idle.success",onError:{actions:"saveRequestError",target:"idle.error"}}}}},{actions:{saveInvalidEmailError:(0,v.assign)({error:i=>x}),saveRequestError:(0,v.assign)({error:(i,{data:{error:d}})=>d})},guards:{invalidEmail:(i,{email:d})=>!w(d)},services:{requestChange:async(i,{email:d,options:c})=>{var s;return(await a.post("/v1/auth/user/email/change",{newEmail:d,options:{redirectTo:((s=c==null?void 0:c.redirectTo)==null?void 0:s.startsWith("/"))?t+c.redirectTo:c==null?void 0:c.redirectTo}},{headers:{authorization:`Bearer ${r==null?void 0:r.state.context.accessToken.value}`}})).data}}})};var S=require("xstate");var pe=({backendUrl:e,interpreter:t})=>{let r=m(e);return(0,S.createMachine)({schema:{context:{},events:{}},tsTypes:{},id:"changePassword",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST_CHANGE:[{cond:"invalidPassword",actions:"saveInvalidPasswordError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:"idle.success",onError:{actions:"saveRequestError",target:"idle.error"}}}}},{actions:{saveInvalidPasswordError:(0,S.assign)({error:a=>I}),saveRequestError:(0,S.assign)({error:(a,{data:{error:i}})=>(console.log(i),i)})},guards:{invalidPassword:(a,{password:i})=>!O(i)},services:{requestChange:(a,{password:i})=>r.post("/v1/auth/user/password",{newPassword:i},{headers:{authorization:`Bearer ${t==null?void 0:t.state.context.accessToken.value}`}})}})};var A=require("xstate");var Ee=({backendUrl:e,clientUrl:t})=>{let r=m(e);return(0,A.createMachine)({schema:{context:{},events:{}},tsTypes:{},id:"changePassword",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST_CHANGE:"requesting"},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:"idle.success",onError:{actions:"saveRequestError",target:"idle.error"}}}}},{actions:{saveRequestError:(0,A.assign)({error:(a,{data:{error:i}})=>(console.log(i),i)})},services:{requestChange:(a,{email:i,options:d})=>{var c;return r.post("/v1/auth/user/password/reset",{email:i,options:{redirectTo:((c=d==null?void 0:d.redirectTo)==null?void 0:c.startsWith("/"))?t+d.redirectTo:d==null?void 0:d.redirectTo}})}}})};var M=({backendUrl:e,clientUrl:t,storageSetter:r,storageGetter:a,autoRefreshToken:i=!0,autoSignIn:d=!0})=>{let c=m(e),h=async(s,n,o)=>(await c.post(s,n,o)).data;return(0,u.createMachine)({schema:{context:{},events:{}},tsTypes:{},context:(0,re.default)(ee,s=>{let n=a(f);n&&(s.accessToken.expiresAt=new Date(n)),s.refreshToken.value=a(R)}),id:"nhost",type:"parallel",states:{authentication:{initial:"checkAutoSignIn",on:{TRY_TOKEN:"#nhost.token.running",SESSION_UPDATE:[{cond:"hasSession",actions:["saveSession","persist","resetTimer"],target:".signedIn"}]},states:{checkAutoSignIn:{always:[{cond:"isAutoSignInDisabled",target:"starting"}],invoke:[{id:"autoSignIn",src:"autoSignIn",onDone:{target:"signedIn",actions:["saveSession","persist"]},onError:"starting"}]},starting:{always:[{cond:"isSignedIn",target:"signedIn"},{cond:"hasRefreshTokenWithoutSession",target:["authenticating.token","#nhost.token.running"]},"signedOut"]},signedOut:{tags:["ready"],initial:"noErrors",states:{noErrors:{},success:{},needsVerification:{},failed:{exit:"resetAuthenticationError",initial:"server",states:{server:{entry:"saveAuthenticationError"},validation:{states:{password:{entry:"saveInvalidPassword"},email:{entry:"saveInvalidEmail"}}}}},signingOut:{entry:"destroyToken",invoke:{src:"signout",id:"signingOut",onDone:"success",onError:"failed.server"}}},on:{SIGNIN_PASSWORD:[{cond:"invalidEmail",target:".failed.validation.email"},{cond:"invalidPassword",target:".failed.validation.password"},"#nhost.authentication.authenticating.password"],SIGNIN_PASSWORDLESS_EMAIL:[{cond:"invalidEmail",target:".failed.validation.email"},"#nhost.authentication.authenticating.passwordlessEmail"],SIGNUP_EMAIL_PASSWORD:[{cond:"invalidEmail",target:".failed.validation.email"},{cond:"invalidPassword",target:".failed.validation.password"},"#nhost.authentication.registering"],SIGNIN_ANONYMOUS:"#nhost.authentication.authenticating.anonymous"}},authenticating:{states:{passwordlessEmail:{invoke:{src:"signInPasswordlessEmail",id:"authenticatePasswordlessEmail",onDone:"#nhost.authentication.signedOut.needsVerification",onError:"#nhost.authentication.signedOut.failed.server"}},password:{invoke:{src:"signInPassword",id:"authenticateUserWithPassword",onDone:{actions:["saveSession","persist"],target:"#nhost.authentication.signedIn"},onError:[{cond:"unverified",target:"#nhost.authentication.signedOut.needsVerification"},{target:"#nhost.authentication.signedOut.failed.server"}]}},token:{},anonymous:{invoke:{src:"signInAnonymous",id:"authenticateAnonymously",onDone:{actions:["saveSession","persist"],target:"#nhost.authentication.signedIn"},onError:"#nhost.authentication.signedOut.failed.server"}}}},registering:{invoke:{src:"registerUser",id:"registerUser",onDone:[{cond:"hasSession",target:"#nhost.authentication.signedIn",actions:["saveSession","persist"]},{target:"#nhost.authentication.signedOut.needsVerification"}],onError:[{cond:"unverified",target:"#nhost.authentication.signedOut.needsVerification"},{actions:"saveRegisrationError",target:"#nhost.authentication.signedOut.failed.server"}]}},signedIn:{tags:["ready"],type:"parallel",on:{SIGNOUT:"#nhost.authentication.signedOut.signingOut"},states:{refreshTimer:{id:"timer",initial:"idle",states:{disabled:{type:"final"},stopped:{always:{cond:"noToken",target:"idle"}},idle:{always:[{cond:"isAutoRefreshDisabled",target:"disabled"},{cond:"hasRefreshToken",target:"running"}]},running:{initial:"pending",entry:"resetTimer",states:{pending:{after:{"1000":{actions:"tickRefreshTimer",internal:!1,target:"pending"}},always:{cond:"refreshTimerShouldRefresh",target:"refreshing"}},refreshing:{invoke:{src:"refreshToken",id:"refreshToken",onDone:{actions:["saveSession","persist","resetTimer"],target:"pending"},onError:[]}}}}}}}}}},token:{initial:"idle",states:{idle:{},running:{invoke:{src:"refreshToken",id:"authenticateWithToken",onDone:{actions:["saveSession","persist"],target:["#nhost.authentication.signedIn","idle"]},onError:{target:["#nhost.authentication.signedOut","idle"]}}}}}}},{actions:{saveSession:(0,u.assign)({user:(s,n)=>{var o,l;return(l=(o=n.data)==null?void 0:o.session)==null?void 0:l.user},accessToken:(s,n)=>{var o,l,g,U;return{value:(l=(o=n.data)==null?void 0:o.session)==null?void 0:l.accessToken,expiresAt:new Date(Date.now()+((U=(g=n.data)==null?void 0:g.session)==null?void 0:U.accessTokenExpiresIn)*1e3)}},refreshToken:(s,n)=>{var o,l;return{value:(l=(o=n.data)==null?void 0:o.session)==null?void 0:l.refreshToken}},mfa:(s,n)=>{var o;return((o=n.data)==null?void 0:o.mfa)??!1}}),resetTimer:(0,u.assign)({refreshTimer:(s,n)=>({elapsed:0,attempts:0})}),tickRefreshTimer:(0,u.assign)({refreshTimer:(s,n)=>({elapsed:s.refreshTimer.elapsed+1,attempts:s.refreshTimer.attempts})}),saveAuthenticationError:(0,u.assign)({errors:({errors:s},{data:{error:n}})=>E(p({},s),{authentication:n})}),resetAuthenticationError:(0,u.assign)({errors:o=>{var{errors:l}=o,g=l,{authentication:s}=g,n=F(g,["authentication"]);return n}}),saveInvalidEmail:(0,u.assign)({errors:({errors:s})=>E(p({},s),{authentication:x})}),saveInvalidPassword:(0,u.assign)({errors:({errors:s})=>E(p({},s),{authentication:I})}),saveRegisrationError:(0,u.assign)({errors:({errors:s},{data:{error:n}})=>E(p({},s),{registration:n})}),persist:(s,{data:n})=>{if(r(R,n.session.refreshToken),n.session.accessTokenExpiresIn){let o=new Date(Date.now()+n.session.accessTokenExpiresIn*1e3).toISOString();r(f,o)}else r(f,null)},destroyToken:()=>{r(R,null),r(f,null)}},guards:{isSignedIn:s=>!!s.user&&!!s.refreshToken.value&&!!s.accessToken.value,hasRefreshTokenWithoutSession:s=>!!s.refreshToken.value&&!s.user&&!s.accessToken.value,noToken:s=>!s.refreshToken.value,hasRefreshToken:s=>!!s.refreshToken.value,isAutoRefreshDisabled:()=>!i,isAutoSignInDisabled:()=>!d,refreshTimerShouldRefresh:s=>s.refreshTimer.elapsed>Math.max((Date.now()-s.accessToken.expiresAt.getTime())/1e3-900,60),unverified:(s,{data:{error:n}})=>n.status===401&&n.message==="Email is not verified",hasSession:(s,n)=>{var o;return!!((o=n.data)==null?void 0:o.session)},invalidEmail:(s,{email:n})=>!w(n),invalidPassword:(s,{password:n})=>!O(n)},services:{signInPassword:(s,{email:n,password:o})=>h("/v1/auth/signin/email-password",{email:n,password:o}),signInPasswordlessEmail:(s,{email:n,options:o})=>{var l;return h("/v1/auth/signin/passwordless/email",{email:n,options:E(p({},o),{redirectTo:((l=o==null?void 0:o.redirectTo)==null?void 0:l.startsWith("/"))?t+o.redirectTo:o==null?void 0:o.redirectTo})})},signInAnonymous:s=>h("/v1/auth/signin/anonymous"),refreshToken:async(s,n)=>{let o=n.type==="TRY_TOKEN"?n.token:s.refreshToken.value;return{session:await h("/v1/auth/token",{refreshToken:o})}},signout:(s,n)=>h("/v1/auth/signout",{refreshToken:s.refreshToken.value,all:!!n.all}),registerUser:(s,{email:n,password:o,options:l})=>{var g;return h("/v1/auth/signup/email-password",{email:n,password:o,options:E(p({},l),{redirectTo:((g=l==null?void 0:l.redirectTo)==null?void 0:g.startsWith("/"))?t+l.redirectTo:l==null?void 0:l.redirectTo})})},autoSignIn:async()=>{if(typeof window<"u"){let s=window.location;if(s.hash){let o=new URLSearchParams(s.hash.slice(1)).get("refreshToken");if(o){let l=await h("/v1/auth/token",{refreshToken:o});return window.history.pushState({},"",s.pathname),new te.BroadcastChannel("nhost").postMessage(o),{session:l}}}throw Error()}}}})};var k=D(require("js-cookie")),C=typeof window<"u",q=e=>C&&localStorage?localStorage.getItem(e):(console.warn("no defaultStorageGetter"),null),L=(e,t)=>{C&&localStorage?t?localStorage.setItem(e,t):localStorage.removeItem(e):console.warn("no defaultStorageSetter")},V=e=>C?k.default.get(e)??null:null,G=(e,t)=>{C&&(t?k.default.set(e,t):k.default.remove(e))};var y,_=class{constructor({backendUrl:t,clientUrl:r=typeof window<"u"?window.location.origin:"",storageGetter:a=q,storageSetter:i=L,autoSignIn:d=!0,autoRefreshToken:c=!0}){X(this,y,void 0);this.backendUrl=t,this.clientUrl=r;let h=M({backendUrl:t,clientUrl:r,storageGetter:a,storageSetter:i,autoSignIn:d,autoRefreshToken:c});this.machine=h,typeof window<"u"&&d&&(z(this,y,new se.BroadcastChannel("nhost")),Q(this,y).addEventListener("message",s=>{var o;let n=(o=this.interpreter)==null?void 0:o.state.context.refreshToken;this.interpreter&&s!==n&&this.interpreter.send({type:"TRY_TOKEN",token:s})}))}};y=new WeakMap;var ne=typeof window!==void 0,H=class extends _{constructor({backendUrl:t}){super({backendUrl:t,autoSignIn:ne,autoRefreshToken:ne,storageGetter:V,storageSetter:G})}};module.exports=ue(fe);0&&(module.exports={MIN_PASSWORD_LENGTH,MIN_TOKEN_REFRESH_INTERVAL,NHOST_JWT_EXPIRES_AT_KEY,NHOST_REFRESH_TOKEN_KEY,Nhost,NhostSSR,REFRESH_TOKEN_RETRY_INTERVAL,REFRESH_TOKEN_RETRY_MAX_ATTEMPTS,TOKEN_REFRESH_MARGIN,cookieStorageGetter,cookieStorageSetter,createChangeEmailMachine,createChangePasswordMachine,createNhostMachine,createResetPasswordMachine,defaultStorageGetter,defaultStorageSetter});
//# sourceMappingURL=index.cjs.js.map
